#set( $attachmentroot = $content.attachmentroot )

#set( $path = "/WEB-INF/data/$catalogid/originals/$asset.sourcepath/" )

#set($rootcategory = $categoryPickerTree.getModel().getRoot())

#set($children = $rootcategory.children)

#macro(showattachments $parentfolder $depth) 
		#set ( $depth = $depth + 1)
		#set ( $padding = (20 * $depth) )
		
		#set( $files = $attachmentManager.listChildren($context, $mediaarchive, $parentfolder ) )
		#foreach($file in $files)
			#set( $filesource  = "${file.parentsourcepath}/${file.name}")
			   <li class="noderow" id="${file.id}_row" data-nodeid="$file.id"><div style="padding-left: ${padding}px"><span class="#if ( $file.folder == 'true' )arrow down #end"></span>#if ( $file.folder == "true" ) <span id="${file.id}_display" class="name folder #if($isleaf) leaf #end">$file.name</span><span id="${file.id}_edit" class="name folder" style="display:none;"><input class="field" type="text" value="$file.name" id="${file.id}_edit_field" /><a class="editsave btn">Save</a><a id="${file.id}" class="editcancel btn">Cancel</a></span>#else<span class="name $!file.fileformat" fileid="${file.id}" sourcepath="$filesource" >$file.name</span>#end<span class="actions">#if ( $file.folder == "true" )<a class="add-folder ir" id="${file.id}">Add New Folder</a><a class="add-file ir" id="${file.id}">Add New File</a><a class="edit ir">Edit</a>#end<a class="delete ir" data-parent="${file.id}">Delete</a></span></div>
					#if($file.folder == "true")  
						<ul class="open" > ##use cookies to open/close them?
						  #showattachments($filesource , $depth)
					   </ul>
					#end
			   </li>
			  #if ( $file.folder == "true" )
			  	<li id="${file.id}_add-folder" style="display: none;"><div class="selected new"><span class="name folder"><input class="field" type="text" value="New Folder" id="${file.id}_new" /><a data-parent="${file.id}" class="save btn">Save</a><a id="${file.id}" class="cancel btn">Cancel</a></span></div></li>
			 	<li id="${file.id}_add-file" style="display: none;"><div class="selected new"><span class="name default"><input class="field" type="text" value="New File" id="${file.id}_new" /><a data-parent="${file.id}" class="browse btn">Browse</a><a data-parent="${file.id}" class="save btn">Save</a><a id="${file.id}" class="cancel btn">Cancel</a></span></div></li>
			  #end	 	
		
			   		
		#end
#end


<div class="ui-widget" >
	<div  class="ui-widget-header">Attachments</div>
	<div  class="ui-widget-content categories-widget no-padding-for-real">
		<div id="attachments-container">
			<div id="tree" class="attachments">
					<ul class="open" >
						<li class="noderow" id="toplevel" data-nodeid="toplevel"><div><span class="arrow down"></span><span class="name folder" fileid="toplevel" sourcepath="$filesource" >Attachments</span><span class="actions"><a class="add-folder ir" id="toplevel">Add New Folder</a><a class="add-file ir" id="toplevel">Add New File</a><a class="edit ir nope">Edit</a><a class="delete ir nope" data-parent="toplevel">Delete</a></span></div>
							<ul class="open" >							
								#showattachments($asset.sourcePath, 1)
							</ul>
						</li>
					 	<li id="toplevel_add-folder" style="display: none;"><div class="selected new"><span class="name folder"><input class="field" type="text" value="New Folder" id="toplevel_new" /><a data-parent="toplevel" class="save btn">Save</a><a id="toplevel" class="cancel btn">Cancel</a></span></div></li>
			 			<li id="toplevel_add-file" style="display: none;"><div class="selected new"><span class="name default"><input class="field" type="text" value="New File" id="toplevel_new" /><a data-parent="toplevel" class="browse btn">Browse</a><a data-parent="toplevel" class="save btn">Save</a><a id="toplevel" class="cancel btn">Cancel</a></span></div></li>
					 </ul>	
<!-- 				
					<li><div><span class="arrow down"></span><span class="name folder">bus.jpg</span><span class="actions"><a>+</a></span></div>
						<ul class="open">
							<li><div><span class="name folder">Empty Inner Folder</span><span class="actions"><a>+</a></span></div></li>
							<li><div><span class="arrow"></span><span class="name folder">Folder 1</span><span class="actions"><a>+</a></span></div>
								<ul>
									<li><div><span class="arrow"></span><span class="name folder">Inner Folder</span><span class="actions"><a>+</a></span></div>
										<ul>
											<li><div><span class="arrow"></span><span class="name folder">Inner Folder</span><span class="actions"><a>+</a></span></div>
												<ul>
													<li><div><span class="arrow"></span><span class="name folder">Inner Folder</span><span class="actions"><a>+</a></span></div></li>
													<li><div><span class="name png">PNG 1</span><span class="actions"><a>+</a></span></div></li>
													<li><div><span class="name jpg">JPG 1 </span><span class="date-uploaded">(12/24/2011 12:24:01)</span><span class="actions"><a>+</a></span></div></li>
													<li><div><span class="name pdf">PDF 1</span><span class="actions"><a>+</a></span></div></li>
													<li><div><span class="name pdf">PDF 2</span><span class="actions"><a>+</a></span></div></li>
												</ul>
											</li>
											<li><div><span class="name png">PNG 1</span><span class="actions"><a>+</a></span></div></li>
											<li><div><span class="name jpg">JPG 1 </span><span class="date-uploaded">(12/24/2011 12:24:01)</span><span class="actions"><a>+</a></span></div></li>
											<li><div><span class="name pdf">PDF 1</span><span class="actions"><a>+</a></span></div></li>
											<li><div><span class="name pdf">PDF 2</span><span class="actions"><a>+</a></span></div></li>
										</ul>
									</li>
									<li><div><span class="name png">PNG 1</span><span class="actions"><a>+</a></span></div></li>
									<li><div><span class="name jpg">JPG 1 </span><span class="date-uploaded">(12/24/2011 12:24:01)</span><span class="actions"><a>+</a></span></div></li>
									<li><div><span class="name pdf">PDF 1</span><span class="actions"><a>+</a></span></div></li>
									<li><div><span class="name pdf">PDF 2</span><span class="actions"><a>+</a></span></div></li>
								</ul>
							</li>
							<li><div><span class="name folder">Folder 2</span><span class="actions"><a>+</a></span></div></li>
							<li><div><span class="name folder">Folder 3</span><span class="actions"><a>+</a></span></div></li>
							<li><div><span class="name folder">Folder 4</span><span class="actions"><a>+</a></span></div></li>
						</ul>
					</li>
				</ul>
-->	
			</div>
		<div id="preview-pane">
		$pages.include("$attachmentroot/details.html")	
		</div>
		</div>
	</div>
</div> <!-- -->

##$sizer.inEnglish($attachment.size)

<a  class="btn" href="reload.html?sourcepath=$asset.sourcePath	">Reload Files</a>

<script type="	text/javascript">

	$('#tree ul li div').on ({
		
		click: function(){
		
			$(this).parent().find('> ul').toggle('fast');
			
			if ( $(this).find('.arrow').hasClass('down') )
			{
				$(this).find('.arrow').removeClass('down');
			}
			else 
			{
				$(this).find('.arrow').addClass('down');
			}
			var file = $(this).find('.name');
			file = $(file);
			var fileid = file.attr("fileid");
			$("#preview-pane").load("$home$attachmentroot/details.html?oemaxlevel=1&assetid=$asset.id&fileid=" + fileid );
		}
	});
	
	$('#tree .field').on( {
		click: function () {
			event.stopPropagation();
		},
		focusin: function(){
			if ($(this).val() == this.defaultValue ) { 
				$(this).val(''); 
			}
		}, 
		focusout: function(){
			if ($(this).val() == "") { 
				$(this).val(this.defaultValue); 
			}
		}
			
	});
	
	$("#tree .add-folder").on({
			click: function (event) {
				
				event.stopPropagation();
				
				var id = $(this).attr("id");
				padding = $("#" + id + "_row div").css('padding-left');
				padding = padding.replace('px', '');
				padding = parseInt(padding);
				padding += 20;
				var node = $(this).parents('.noderow:first').data('nodeid');
				
				if ( $("#" + id + "_row > div .arrow").length > 0 ) {
					if ( $("#" + id + "_row > div .arrow").hasClass('down') ) {	
						
					} else {
					   $("#" + id + "_row").find('> ul').toggle('fast');
					   $("#" + id + "_row > div .arrow").addClass('down');
					   jQuery.get("$home$apphome/views/settings/metadata/categories/expandnode.html?nodeID=" + node);
					}
				} else {
					$("#" + id + "_row > div").prepend('<span class="arrow down" id="newarrow"></span>');
					$("#" + id + "_row").find('> ul').toggle('fast');
					$("#" + id + "_row > div .arrow").addClass('down');
				}
				
				$("#" + id + "_add-folder").show("fast");
				$("#" + id + "_add-folder div").css('padding-left', padding )
				$("#" + id + "_row > div").addClass('selected');
				$("#" + id + "_add input").focus();
			}
	} );
	
	$("#tree .add-file").on({
			click: function (event) {
				
				event.stopPropagation();
				
				var id = $(this).attr("id");
				padding = $("#" + id + "_row div").css('padding-left');
				padding = padding.replace('px', '');
				padding = parseInt(padding);
				padding += 20;
				var node = $(this).parents('.noderow:first').data('nodeid');
				
				if ( $("#" + id + "_row > div .arrow").length > 0 ) {
					if ( $("#" + id + "_row > div .arrow").hasClass('down') ) {	
						
					} else {
					   $("#" + id + "_row").find('> ul').toggle('fast');
					   $("#" + id + "_row > div .arrow").addClass('down');
					   jQuery.get("$home$apphome/views/settings/metadata/categories/expandnode.html?nodeID=" + node);
					}
				} else {
					$("#" + id + "_row > div").prepend('<span class="arrow down" id="newarrow"></span>');
					$("#" + id + "_row").find('> ul').toggle('fast');
					$("#" + id + "_row > div .arrow").addClass('down');
				}
				
				$("#" + id + "_add-file").show("fast");
				$("#" + id + "_add-file div").css('padding-left', padding )
				$("#" + id + "_row > div").addClass('selected');
				$("#" + id + "_add input").focus();
			}
	} );
	
	$("#tree .cancel").on({
		click: function (event) {
			
			event.stopPropagation();
			

			$("#newarrow").remove();
	
			var id = $(this).attr("id");	
			$("#" + id + "_add-folder").hide("fast");
			$("#" + id + "_add-file").hide("fast");
			$("#" + id + "_row > div").removeClass('selected');
		}
	
	} );
	
	$("#tree .edit").on({
		click: function (event) {
				event.stopPropagation();
				var id = $(this).parents('.noderow:first').data('nodeid');
	
				
				jQuery("#" + id +"_display").hide("fast");
				jQuery("#" + id +"_edit").show("fast");		
				
				return false;
		}
	});
	
	$("#tree .editcancel").on({
		click: function (event) {
				event.stopPropagation();
				var id = $(this).parents('.noderow:first').data('nodeid');
	
				
				jQuery("#" + id +"_display").show("fast");
				jQuery("#" + id +"_edit").hide("fast");		
				return false;
		}
	});
	$("#tree .editsave").on({
		click: function (event) {
				event.stopPropagation();
				var id = $(this).parents('.noderow:first').data('nodeid');

				
				
				var newname = $("#" + id + "_edit_field").attr("value");
				jQuery.get("$apphome/views/detaileditor/attachments/savecategory.html", {
					'id': id,
					categoryid: id,
					'name': newname
				
					} , function () {						
						jQuery("#" + id +"_display").show("fast");
						jQuery("#" + id +"_edit").hide("fast");		
						jQuery("#" + id + "_display").html(newname);
					}
				
				);
				repaint();
				return false;
		}
	
	});
	
	repaint = function () {
		jQuery("#attachments-tree").load("$apphome/views/detaileditor/attachments/files.html");
		
		
	}
	
</script>