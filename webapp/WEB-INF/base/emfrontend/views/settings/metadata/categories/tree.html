#set($rootcategory = $categoryPickerTree.getModel().getRoot())

#set($children = $rootcategory.children)

#macro(showtreecategories $categories $depth) 
		#set ( $depth = $depth + 1)
		#set ( $padding = (20 * $depth) )
		#foreach($cat in $categories)
		#set( $isleaf = $cat.hasChildren())
		#set( $open = $isleaf)
		#set( $checked = false )
		#set( $checked = $asset.isInCategory($cat))
		<li class="noderow" id="${cat.id}_row" data-nodeid="$cat.id"><div style="padding-left: ${padding}px">#if($isleaf)<span class="arrow #if($categoryPickerTree.isExpanded($cat))down #end "></span>#end <span id="${cat.id}_display" class="name folder #if($isleaf) leaf #end">$cat.name</span><span id="${cat.id}_edit" class="name folder" style="display:none;"><input class="field" type="text" value="$cat.name" id="${cat.id}_edit_field" /><a class="editsave btn">Save</a><a id="${cat.id}" class="editcancel btn">Cancel</a></span><span class="actions"><a class="edit ir">Edit</a><a class="add ir" id="$cat.id">Add New</a><a data-parent="${cat.id}" class="delete ir">Delete</a></span></div>
		#if($isleaf)
		   <ul #if($categoryPickerTree.isExpanded($cat)) class="open" #end >
			  #showtreecategories($cat.getChildren(), $depth)
		   </ul>
		#end

		</li>
		<li id="${cat.id}_add" style="display: none;"><div class="selected new"><span class="name folder"><input class="field" type="text" value="New Category" id="${cat.id}_new" /><a data-parent="${cat.id}" class="save btn">Save</a><a id="${cat.id}" class="cancel btn">Cancel</a></span></div></li>		 	
		
		#end
#end

<div class="ui-widget" >
	<div  class="ui-widget-header">Categories</div>
	<div  class="ui-widget-content categories-widget no-padding-for-real">
		<div id="attachments-container">
			<div id="tree" class="attachments">
				
				<ul  class="open">
					<li class="noderow" id="${rootcategory.id}_row"><div><span class="arrow down"></span><span class="name folder">$rootcategory.name</span><span class="actions"><a class="edit ir nope">Edit</a><a class="add ir" id="${rootcategory.id}">Add New</a><a class="delete ir nope" data-parent="${rootcategory.id}">Delete</a></span></div>
						<ul class="open">
							#showtreecategories($children, 1)
						</ul>
					</li>
					<li id="${rootcategory.id}_add" style="display: none;"><div class="selected new"><span class="name folder"><input class="field" type="text" value="New Category" id="${rootcategory.id}_new" /><a data-parent="${rootcategory.id}" class="save btn">Save</a><a id="${rootcategory.id}" class="cancel btn">Cancel</a></span></div></li>		 	
				</ul>

			</div>
		</div>
	</div>
</div>




<script>

	$('#tree ul li div').on({
		click :  function(){
		
			$(this).parent().find('> ul').toggle('fast');
			var node = $(this).parents('.noderow:first').data('nodeid');

			if ( $(this).find('.arrow').hasClass('down') ){
				$(this).find('.arrow').removeClass('down');
				
				jQuery.get("$home$apphome/views/settings/metadata/categories/collapsenode.html?nodeID=" + node);
			}
			else { 
				$(this).find('.arrow').addClass('down');
				
				jQuery.get("$home$home$apphome/views/settings/metadata/categories/expandnode.html?nodeID=" + node);

			}
				
		}
	});
	
	$('#tree .field').on( {
		click: function () {
			event.stopPropagation();
		},
		focusin: function(){
			if ($(this).val() == this.defaultValue ) { 
				$(this).val(''); 
			}
		}, 
		focusout: function(){
			if ($(this).val() == "") { 
				$(this).val(this.defaultValue); 
			}
		}
			
	});
	
	
	$("#tree .add").on({
			click: function (event) {
				
				event.stopPropagation();
				
				var id = $(this).attr("id");
				padding = $("#" + id + "_row div").css('padding-left');
				padding = padding.replace('px', '');
				padding = parseInt(padding);
				padding += 20;
				var node = $(this).parents('.noderow:first').data('nodeid');
				
				if ( $("#" + id + "_row > div .arrow").length > 0 ) {
					if ( $("#" + id + "_row > div .arrow").hasClass('down') ) {	
						
					} else {
					   $("#" + id + "_row").find('> ul').toggle('fast');
					   $("#" + id + "_row > div .arrow").addClass('down');
					   jQuery.get("$home$apphome/views/settings/metadata/categories/expandnode.html?nodeID=" + node);
					}
				} else {
					$("#" + id + "_row > div").prepend('<span class="arrow down" id="newarrow"></span>');
					$("#" + id + "_row").find('> ul').toggle('fast');
					$("#" + id + "_row > div .arrow").addClass('down');
				}
				
				$("#" + id + "_add").show("fast");
				$("#" + id + "_add div").css('padding-left', padding )
				$("#" + id + "_row > div").addClass('selected');
				$("#" + id + "_add input").focus();
			}
	} );
	
	
	$("#tree .cancel").on({
		click: function (event) {
			
			event.stopPropagation();
			

			$("#newarrow").remove();
	
			var id = $(this).attr("id");	
			$("#" + id + "_add").hide("fast");
			$("#" + id + "_row > div").removeClass('selected');
		}
	
} );
	
	$("#tree .delete").on({
		click: function (event) {
			event.stopPropagation();

			var id = $(this).data('parent');
			
			var agree=confirm("Are you sure you want to delete?");
			if (agree){
				jQuery.get("$apphome/views/settings/metadata/categories/deletecategory.html", {
					categoryid: id,
				
				
					} ,function () {
						$("#" + id + "_row").hide( 'fast', function(){
							repaint(); 
						} );
						
					});
				
			
			}
			else{
				return false;
			}
		}
	
} );
			
	$("#tree .save").on({
			click: function (event) {
					event.stopPropagation();
					var id = $(this).data("parent");
					//alert("parent category was: " + id);
					var newname = $("#" + id + "_new").attr("value");
					//alert("New name: " + newname);
					jQuery.get("$apphome/views/settings/metadata/categories/addcategory.html", {
						categoryid: id,
						'newname': newname
					
						} , function () {
							$("#" + id + "_add").hide("fast", function(){
							repaint(); 
							});
						}
					
					);
					
			}
		
	} );
	
	
	$("#tree .edit").on({
		click: function (event) {
				event.stopPropagation();
				var id = $(this).parents('.noderow:first').data('nodeid');

				
				jQuery("#" + id +"_display").hide("fast");
				jQuery("#" + id +"_edit").show("fast");		
				
				return false;
		}
	
} );
	

	$("#tree .editcancel").on({
		click: function (event) {
				event.stopPropagation();
				var id = $(this).parents('.noderow:first').data('nodeid');

				
				jQuery("#" + id +"_display").show("fast");
				jQuery("#" + id +"_edit").hide("fast");		
				return false;
		}
	
} );

	$("#tree .editsave").on({
		click: function (event) {
				event.stopPropagation();
				var id = $(this).parents('.noderow:first').data('nodeid');

				
				
				var newname = $("#" + id + "_edit_field").attr("value");
				jQuery.get("$apphome/views/settings/metadata/categories/savecategory.html", {
					'id': id,
					categoryid: id,
					'name': newname
				
					} , function () {						
						jQuery("#" + id +"_display").show("fast");
						jQuery("#" + id +"_edit").hide("fast");		
						jQuery("#" + id + "_display").html(newname);
					}
				
				);
				repaint();
				return false;
		}
	
} );
	
	
	
	
	repaint = function () {
		jQuery("#category-tree").load("$apphome/views/settings/metadata/categories/tree.html");
		
		
	}
</script>