<h2>Aspera Download</h2>

#set( $itemid = $context.getRequestParameter("itemid"))
#set($item = $searcherManager.getData($catalogid, "orderitem",$itemid) )

#set($destinationid = $order.findValue($item,"publishdestination"))
#set($publishdestination = $searcherManager.getData($catalogid,"publishdestination", $destinationid)) 
   
#set( $asset = $mediaarchive.getAssetBySourcePath( $item.get("assetsourcepath") ) )
 
#set($presetid = $order.findValue($item,"presetid"))
#if( $presetid )
	#set($preset = $searcherManager.getData($catalogid,"convertpreset", $presetid))
	#set( $presetpath = $mediaarchive.asExportFileName($asset,$preset) )
#else
	No preset id set	
#end
  
<p id="install_message">
  
</p>

<div id="objectholder">

</div>


<object id="aspera-web" type="application/x-aspera-web" width="1" height="1"><param name="AW_IMGSRV" value="" ></object>

  <script language="JavaScript">
  	//var connect  = new AsperaWeb('aspera-web');
  	function downloadNow()
  	{
		var aspera = document.getElementById('aspera-web');

 		#set( $username = $publishdestination.get("username") )
 		#set( $theuser = $userManager.getUser($username) )
 		#set( $password = $userManager.decryptPassword($theuser) )
 		var sourceURL = 'fasp://${username}:${password}@${publishdestination.get("server")}${publishdestination.get("url")}/$presetpath?v=2&bwcap=Unlimited&targetrate=20000';
		aspera.startDownloadToPath(sourceURL, "$presetpath");
		//aspera.displayTransferManager();
		jQuery('#install_message').html( "Download progress in Aspera system tray" );
		return false;    
  	}	
  	var refreshPage = function() 
  	{
	  	location.reload();
  	};

 	function installProgressCallback(event) {
  	  var msg = ""; 
  	  if (event.state == "ERROR") 
  	  {
  	    msg += "Installation Error - " + event.description;
  	  }
  	  else if ((event.state == "DOWNLOAD")||(event.state == "START")||(event.state == "INSTALL"))
  	  {
  		msg = '<div class="ui-state-highlight"><img src="$home$themeprefix/images/spinner.gif"/> ' +  "Installing Aspera Plugin " + event.percent + "%" + '</div>';
  		//$('aspera_progress_bar_percent').style.width = ""+evnt.percent+"%";
  	  }
  	  else if (event.state == "COMPLETE")
  	  {
  	  	//downloadNow();
  	  	//or reload this page
  	  	msg ="Reloading page";
  	  	
  	  	try 
  	  	{
			new ConnectInstaller('aspera-web',url).reloadPlugins();
    	}
    	catch(e) 
    	{
    		
		}
		var aspera = jQuery('#aspera-web');
		aspera.remove();
		
		setTimeout(refreshPage, 2000);//refresh the page to run checks again and report to the user
  	  	//reload page
  	  	//window.location = "$home$apphome/views/activity/aspera/asperadownload.html?itemid=$itemid&orderid=$order.id&cache=false"
  	  }
  	  jQuery('#install_message').html( msg );
  	} 
  	
    function checkInstall() 
    {
    	var asperaWeb = new AsperaWeb('aspera-web');

      	if (asperaWeb.isInstalled()) 
      	{
      		// Wait a few seconds to give the aspera client a chance to start before downloading
			setTimeout(downloadNow,2000);
      	}
      	else
      	{
      		if (navigator.platform.indexOf("Mac") != -1)
      		{
      			jQuery('#install_message').html( "Please restart your browser to finish installing plugin." );
      		}
      		else 
      		{
        		window.location = "$home$apphome/views/activity/aspera/asperainstall.html?itemid=$itemid&orderid=$order.id&cache=false"
      		}
      	}
    }
    
    jQuery(document).ready(
		function()
		{
			checkInstall();
		}
	);
   
	
	
  </script>
