##required: catalogid, searchtype, view, fieldname
##optional: value, foreignkeyid and foreignkeyvalue

#set ($catalogid = $context.getRequestParameter('catalogid'))
#set ($searchtype = $context.getRequestParameter('searchtype')) ##product
#set ($fieldname = $context.getRequestParameter('fieldname')) ##lastmodified
#set ($view = $context.getRequestParameter('view')) 

<div id="listdetail_$fieldname" class="listdetailpicker">
##we need to load up the existing detail object

#set( $originalsearcher = $searcherManager.getSearcher($catalogid, $searchtype))
#if( !$detail) ##this is new. To reduce complexity we want to just load up the detail all the time
    #set( $detail = $originalsearcher.getDetailForView($view, $fieldname, $user) )
#end

#set( $listid = $detail.getListId())
#set( $lsearcher = $searcherManager.getSearcher( $detail.getListCatalogId(), $listid )) 
##optional things to filter the list
#set ($foreignkeyid = $detail.get("foreignkeyid") )

#set ($foreignkeyvalue = $context.getRequestParameter('foreignkeyvalue'))

#set ($squery = $detail.query )

#if ($foreignkeyid && $foreignkeyvalue)
    #set( $foreigndetail = $originalsearcher.getDetailForView($view, $foreignkeyid, $user) )
    
    #if( $foreigndetail && $foreigndetail.listid )
        #set( $foreignfield = $foreigndetail.listid )
    #else
        #set( $foreignfield = $foreignkeyid )
    #end
    #set ($query = $lsearcher.createSearchQuery())
    #set ($o = $query.setAndTogether(false))
    #set ($o = $query.addMatches("$foreignfield", "$foreignkeyvalue"))
#elseif( $squery && (!$detail.getType() || $detail.getType() != "textjoin") )
    #set ($query = $lsearcher.parse($squery))
#else
    #set ($query = $lsearcher.createSearchQuery())
    #set ($o = $query.addMatches("id", "*"))
#end

#if ($detail.sort)
    $query.setSortBy($detail.sort)
#end
#set ($types = $lsearcher.search($query))
#if( !$value )
    #set ($value = $context.getRequestParameter('value'))
#end
#if (!$value)
  #set ($value = $context.getRequestParameter("${fieldname}.value"))
#end

#set( $valueid = "$fieldname" )



#if($types)
    #if( $foreignkeyid)
        <script type="text/javascript">
            addListListener("$foreignkeyid", "${fieldname}");
        </script>
    #end
    <select id="list-$listid" name="$!detailprefix${valueid}.value" class="autosubmited #if($detail.isRequired()) required #end" listid="$listid" id="${valueid}.value" onchange="if( typeof updatelisteners == 'function' )updatelisteners('$catalogid','$searchtype','$!view','$fieldname');" >
    #if ($detail.blankoption != false)
    <option value=""></option>
    #end
    #foreach( $type in $types )
        #set( $key = $type.id)
        <option value="$key" #if( $value && $key == $value ) selected #end>
            #esc($type.name)
        </option>
    #end
   </select>
#else
    No properties found in ../configuration/lists/#esc(${listid}).xml 
#end

<div class="editfield" id="listeditor-$listid" style="display: none;">
    <form>
        <input type="text" />
        <input class="btn" type="submit" value="Save" />
        <a class="btn cancel" style="margin: -5px 0; top: 0px;" style="cursor: pointer;">Cancel</a>
    </form>
</div>

<div class="hidden right">
    <a id="listeditorbtn-$listid" style="margin: -5px 0" class="btn right">Add New Value</a>
</div>

<script>
    $('#listeditorbtn-$listid').click(function(){
        $('#list-$listid').hide();
        $('#listeditor-$listid').show();
        $('#listeditorbtn-$listid').hide();
    })
    $('#listeditor-$listid .cancel').click(function(){
        $('#list-$listid').show();
        $('#listeditor-$listid').hide();
        $('#listeditorbtn-$listid').show();
    })
</script>

</div>